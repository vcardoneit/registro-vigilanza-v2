{% load static %}
{% now "Y-m-d" as oggi %}
<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Registro Vigilanza | Dashboard</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'bootstrap-icons/bootstrap-icons.min.css' %}">
    <link href="{% static 'css/customHome.css' %}" rel="stylesheet">
</head>

<body>
    <header class="main-header">
        <div class="container-fluid px-3">
            <div class="d-flex align-items-center justify-content-between">
                <a href="#" class="logo" id="navbar-brand-logo">
                    <i class="bi bi-shield-check" style="font-size: 1.5rem;"></i>
                    <span>Vigilanza</span>
                </a>

                <div class="d-flex align-items-center gap-2">
                    <div class="user-badge d-flex">
                        <div class="user-avatar">{{ request.user.username|make_list|first|upper }}</div>
                        <span>{{ request.user.get_full_name|default:request.user.username }}</span>
                    </div>

                    <form method="post" action="{% url 'logout' %}" class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="btn-primary btn-danger" onclick="return confirm('Terminare il turno?');" style="padding: 0.625rem 0.875rem;">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Esci</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </header>

    {% if messages %}
    <div class="px-3 mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            <i class="bi bi-{% if message.tags == 'success' %}check-circle-fill{% elif message.tags == 'warning' %}exclamation-triangle-fill{% else %}x-circle-fill{% endif %}"></i>
            <span style="flex: 1;">{{ message }}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" style="font-size: 0.6rem;"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <main class="dashboard-grid">
        <aside>
            <div class="clock-display">
                <div class="clock-time" id="current-time">--:--:--</div>
                <div class="clock-date" id="current-date">--</div>
            </div>

            <div class="card sidebar-section">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-bar-chart-fill text-primary"></i>
                        Statistiche Turno
                    </h3>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Inizio</div>
                            <div class="stat-value">{{ turno_attivo.orario_inizio|date:"H:i" }}</div>
                            <div class="stat-sub">{{ turno_attivo.orario_inizio|date:"d/m" }}</div>
                        </div>
                        <div class="stat-card accent">
                            <div class="stat-label">Accessi</div>
                            <div class="stat-value">{{ accessi|length }}</div>
                            <div class="stat-sub">oggi</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card sidebar-section">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-calendar3 text-warning"></i>
                        Ricerca Data
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post" action="">
                        {% csrf_token %}
                        <div class="search-bar mb-2">
                            <input type="date" class="form-input" id="data_ricerca" name="data_ricerca" value="{{ data|date:"Y-m-d" }}" required>
                            <button type="submit" class="btn-primary">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <a href="" class="btn-secondary btn-block" style="text-decoration: none;">
                            <i class="bi bi-arrow-counterclockwise me-2"></i> Oggi
                        </a>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-telegram text-info"></i>
                        Messaggi INAF
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'messaggioTelegram' %}">
                        {% csrf_token %}
                        <textarea class="form-input mb-2" name="messaggio" rows="3" placeholder="Scrivi un messaggio..."></textarea>
                        <button type="submit" class="btn-primary btn-block">
                            <i class="bi bi-send-fill"></i> Invia
                        </button>
                    </form>
                </div>
            </div>
        </aside>

        <section>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-people-fill text-primary"></i>
                        Personale Esterno
                    </h3>
                    {% if data|date:"Y-m-d" == oggi %}
                    <button type="button" class="btn-primary" data-bs-toggle="modal" data-bs-target="#aggiungiPersonaleEsternoModal" style="padding: 0.625rem 0.875rem;">
                        <i class="bi bi-plus-lg"></i>
                        <span>Nuovo</span>
                    </button>
                    {% endif %}
                </div>

                {% if accessi %}
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Custode</th>
                                <th>Nominativi</th>
                                <th>Ditta</th>
                                <th>Ingresso</th>
                                <th>Uscita</th>
                                {% if data|date:"Y-m-d" == oggi %}<th></th>{% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for accesso in accessi %}
                            <tr class="{% if accesso.oraIngresso|date:'Y-m-d' != data|date:'Y-m-d' %}past{% elif not accesso.oraUscita %}present{% endif %}">
                                <td>
                                    <strong>{{ accesso.turno.vigilante.get_full_name|default:accesso.turno.vigilante.username }}</strong>
                                </td>
                                <td>{{ accesso.nominativi }}</td>
                                <td>{{ accesso.ditta }}</td>
                                <td>{{ accesso.oraIngresso|date:"H:i" }}</td>
                                <td>
                                    {% if accesso.oraUscita %}
                                        <span class="text-muted">{{ accesso.oraUscita|date:"H:i" }}</span>
                                    {% else %}
                                        <span class="badge badge-success">
                                            <i class="bi bi-circle-fill" style="font-size: 0.4rem;"></i> Presente
                                        </span>
                                    {% endif %}
                                </td>
                                {% if data|date:"Y-m-d" == oggi %}
                                <td>
                                    <button class="btn-ghost" data-bs-toggle="modal" data-bs-target="#modificaPersonaleEsternoModal"
                                            data-id="{{ accesso.id }}"
                                            data-nominativi="{{ accesso.nominativi }}"
                                            data-ditta="{{ accesso.ditta }}"
                                            data-ora-ingresso="{{ accesso.oraIngresso|date:'H:i' }}"
                                            data-ora-uscita="{{ accesso.oraUscita|date:'H:i' }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>Nessun accesso registrato</p>
                </div>
                {% endif %}
            </div>

            <form method="post" action="{% url 'aggiornaRegistro' %}" class="mt-3">
                {% csrf_token %}
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="bi bi-journal-text text-warning"></i>
                            Rapporto Turno
                        </h3>
                        {% if data|date:"Y-m-d" == oggi %}
                        <button type="submit" class="btn-primary" style="padding: 0.625rem 0.875rem;">
                            <i class="bi bi-check-lg"></i>
                            <span>Salva</span>
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="form-group mb-0">
                                    <label class="form-label">Note del giorno</label>
                                    <textarea class="form-input" name="note" rows="5" 
                                        placeholder="Annotazioni, eventi..."
                                        {% if not data|date:"Y-m-d" == oggi %}disabled{% endif %}>{{ note }}</textarea>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group mb-0">
                                    <label class="form-label">Presenze INAF</label>
                                    <div class="checklist {% if not data|date:'Y-m-d' == oggi %}checklist-readonly{% endif %}">
                                        {% if data|date:"Y-m-d" == oggi %}
                                            {% for persona in listaPersonaleINAF %}
                                            <div class="checklist-item">
                                                <input type="checkbox" id="p_{{ persona.id }}" name="personale_ids" value="{{ persona.id }}"
                                                    {% if persona.id in personaleINAFpresente %}checked{% endif %}>
                                                <label for="p_{{ persona.id }}">{{ persona.nominativo }}</label>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            {% for p in listaPersonaleINAF %}
                                            <div class="checklist-item">
                                                {% if p.is_present %}
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                                {% else %}
                                                <i class="bi bi-x-circle text-muted"></i>
                                                {% endif %}
                                                <span>{{ p.personale.nominativo }}</span>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </section>

        <aside>
            <div class="card marcatura-card sidebar-section" id="marcatura-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-stopwatch text-danger"></i>
                        Marcatura
                    </h3>
                </div>
                <div class="card-body">
                    <div class="marcatura-times">
                        <div class="time-box">
                            <div class="time-label">Ultima</div>
                            <div class="time-value" id="ultima_marcatura">{% if ultimaMarcatura %}{{ ultimaMarcatura.orario|date:"H:i" }}{% else %}-{% endif %}</div>
                        </div>
                        <div class="time-box next">
                            <div class="time-label">Prossima</div>
                            <div class="time-value" id="prossima_marcatura">--:--</div>
                        </div>
                    </div>
                    <form method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="esegui_marcatura" value="1">
                        <button type="submit" class="btn-primary btn-block btn-lg" id="btnMarcatura">
                            <i class="bi bi-check2-circle"></i> Esegui Marcatura
                        </button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-info-circle text-info"></i>
                        Info Turno
                    </h3>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-3">
                        <div>
                            <div class="form-label">Vigilante</div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="user-avatar" style="width: 28px; height: 28px; font-size: 0.75rem;">
                                    {{ request.user.username|make_list|first|upper }}
                                </div>
                                <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
                            </div>
                        </div>
                        <div>
                            <div class="form-label">Data Visualizzata</div>
                            <strong>{{ data|date:"l d F Y" }}</strong>
                        </div>
                        <div>
                            <div class="form-label">Stato</div>
                            {% if data|date:"Y-m-d" == oggi %}
                            <span class="badge badge-success">
                                <i class="bi bi-circle-fill" style="font-size: 0.4rem;"></i> Turno Attivo
                            </span>
                            {% else %}
                            <span class="badge badge-muted">
                                <i class="bi bi-archive"></i> Archivio
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <div class="modal fade" id="aggiungiPersonaleEsternoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus-fill text-primary me-2"></i>
                        Nuovo Accesso
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="{% url 'registraAccesso' turno_attivo.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Nominativi (uno per riga)</label>
                            <textarea class="form-input" name="nominativi" rows="3" required placeholder="Mario Rossi&#10;Luigi Bianchi"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ditta</label>
                            <input type="text" class="form-input" name="ditta" required placeholder="Nome azienda">
                        </div>
                        <div class="form-group mb-0">
                            <label class="form-label">Ora Ingresso</label>
                            <input type="time" class="form-input" name="oraIngresso" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn-primary">
                            <i class="bi bi-check-lg"></i> Registra
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modificaPersonaleEsternoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square text-warning me-2"></i>
                        Modifica Accesso
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="" id="editForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Nominativi</label>
                            <input type="text" class="form-input" id="edit_nominativi" name="nominativi" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ditta</label>
                            <input type="text" class="form-input" id="edit_ditta" name="ditta" required>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="form-group mb-0">
                                    <label class="form-label">Ingresso</label>
                                    <input type="time" class="form-input" id="edit_oraIngresso" name="oraIngresso" required>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group mb-0">
                                    <label class="form-label">Uscita</label>
                                    <input type="time" class="form-input" id="edit_oraUscita" name="oraUscita">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="submit" formaction="" id="deleteBtn" class="btn-ghost text-danger" 
                            onclick="return confirm('Eliminare questo accesso?');">
                            <i class="bi bi-trash"></i> Elimina
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn-secondary" data-bs-dismiss="modal">Annulla</button>
                            <button type="submit" class="btn-primary">
                                <i class="bi bi-check-lg"></i> Aggiorna
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="replyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-dots-fill text-info me-2"></i>
                        Messaggio INAF
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reply-box" class="p-3 rounded" style="background: var(--bg-muted); max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <img id="bouncing-cat" src="{% static 'cat.gif' %}" alt="">

    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script>
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const date = now.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            
            const el = document.getElementById('current-time');
            const dateEl = document.getElementById('current-date');
            if (el) el.textContent = time;
            if (dateEl) dateEl.textContent = date;
            
            checkMarcatura(now);
        }

        let alertState = 'ok';
        
        function checkMarcatura(now) {
            const lastEl = document.getElementById('ultima_marcatura');
            const nextEl = document.getElementById('prossima_marcatura');
            const btn = document.getElementById('btnMarcatura');
            const card = document.getElementById('marcatura-card');
            
            const lastVal = lastEl?.textContent?.trim();
            if (!lastVal || lastVal === '-' || !lastVal.includes(':')) {
                if (nextEl) nextEl.textContent = '--:--';
                return;
            }

            const [h, m] = lastVal.split(':').map(Number);
            let lastDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
            if (lastDate > now) lastDate.setDate(lastDate.getDate() - 1);
            
            const deadline = new Date(lastDate.getTime() + 60 * 60 * 1000);
            const nextTime = deadline.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            if (nextEl) nextEl.textContent = nextTime;

            const minLeft = Math.floor((deadline - now) / 60000);

            if (card) card.classList.remove('warning', 'urgent');
            if (btn) { btn.style.background = ''; btn.style.animation = ''; }

            if (minLeft <= 5) {
                if (card) card.classList.add('urgent');
                if (btn) { btn.style.background = 'var(--danger)'; btn.style.animation = 'pulse-bar 0.5s infinite'; }
                if (alertState !== 'urgent' && minLeft > -60) {
                    alert(`⚠️ URGENTE!\n\nMarcatura entro le ${nextTime}\n(Mancano meno di 5 minuti)`);
                    alertState = 'urgent';
                }
            } else if (minLeft <= 15) {
                if (card) card.classList.add('warning');
                if (btn) btn.style.background = 'var(--warning)';
                if (alertState !== 'warning') {
                    alert(`ℹ️ AVVISO\n\nProssima marcatura: ${nextTime}\n(15 minuti)`);
                    alertState = 'warning';
                }
            } else {
                alertState = 'ok';
            }
        }

        setInterval(updateClock, 1000);
        updateClock();

        const editModal = document.getElementById('modificaPersonaleEsternoModal');
        if (editModal) {
            editModal.addEventListener('show.bs.modal', e => {
                const btn = e.relatedTarget;
                const id = btn.dataset.id;
                
                document.getElementById('edit_nominativi').value = btn.dataset.nominativi || '';
                document.getElementById('edit_ditta').value = btn.dataset.ditta || '';
                document.getElementById('edit_oraIngresso').value = btn.dataset.oraIngresso || '';
                document.getElementById('edit_oraUscita').value = btn.dataset.oraUscita || '';
                
                document.getElementById('editForm').action = `/aggiornaAccesso/${id}/`;
                document.getElementById('deleteBtn').setAttribute('formaction', `/eliminaAccesso/${id}/`);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const replyModal = new bootstrap.Modal(document.getElementById('replyModal'));
            const replyBox = document.getElementById('reply-box');
            
            try {
                const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/replies/');
                ws.onmessage = e => {
                    const { message } = JSON.parse(e.data);
                    const time = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    replyBox.innerHTML += `<div class="mb-2 pb-2 border-bottom"><strong class="text-primary">${time}</strong>: ${message}</div>`;
                    replyModal.show();
                };
            } catch (e) {
                console.warn('WebSocket non disponibile');
            }

            const cat = document.getElementById('bouncing-cat');
            let x = 0, y = 0, dx = 4, dy = 4, moving = false;
            
            function moveCat() {
                if (!moving) return;
                const w = window.innerWidth, h = window.innerHeight;
                const catW = cat.offsetWidth || 120;
                const catH = cat.offsetHeight || 120;
                if (x + catW >= w || x <= 0) { dx = -dx; cat.style.transform = `scaleX(${dx > 0 ? 1 : -1})`; }
                if (y + catH >= h || y <= 0) dy = -dy;
                x += dx; y += dy;
                cat.style.left = x + 'px';
                cat.style.top = y + 'px';
                requestAnimationFrame(moveCat);
            }

            document.getElementById('navbar-brand-logo')?.addEventListener('dblclick', e => {
                e.preventDefault();
                if (moving) return;
                x = Math.random() * (window.innerWidth - 150);
                y = Math.random() * (window.innerHeight - 150);
                cat.style.left = x + 'px';
                cat.style.top = y + 'px';
                cat.style.display = 'block';
                setTimeout(() => cat.style.opacity = '1', 50);
                moving = true;
                moveCat();
                setTimeout(() => {
                    cat.style.opacity = '0';
                    setTimeout(() => { moving = false; cat.style.display = 'none'; }, 500);
                }, 15000);
            });
        });
    </script>
</body>
</html>